services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: claude-code-api:latest
    container_name: claude-code-api
    ports:
      - "7742:7742"
    environment:
      # Pass OAuth token from: claude setup-token
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
    volumes:
      # Named volume for Claude CLI data (debug logs, cache)
      - claude-code-data:/home/appuser/.claude
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7742/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Development service with hot reload
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: claude-code-api:dev
    container_name: claude-code-api-dev
    ports:
      - "7744:7742"
    environment:
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
    volumes:
      - claude-code-data:/home/appuser/.claude
      - ./claude_code_api:/app/claude_code_api:ro
    command: ["uvicorn", "claude_code_api.server:app", "--host", "0.0.0.0", "--port", "7742", "--reload"]
    profiles:
      - dev

volumes:
  claude-code-data:
